---
// No server-side logic needed for the search bar
---

<div class="relative max-w-2xl mx-auto">

  <div class="relative">
    <!-- Search Icon -->
    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
      <svg 
        class="w-5 h-5 text-gray-400 dark:text-gray-500" 
        fill="none" 
        stroke="currentColor" 
        viewBox="0 0 24 24"
      >
        <path 
          stroke-linecap="round" 
          stroke-linejoin="round" 
          stroke-width="2" 
          d="m21 21-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
        ></path>
      </svg>
    </div>
    
    <!-- Search Input -->
    <input
      id="search-input"
      type="search"
      placeholder="Search for a country..."
      class="w-full pl-10 pr-16 py-3 text-gray-900 dark:text-white bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:focus:ring-primary-400 dark:focus:border-primary-400 transition-colors duration-200"
      autocomplete="off"
    />
    
    <!-- Search Button & Clear Button -->
    <div class="absolute inset-y-0 right-0 flex items-center pr-2">
      <button
        id="clear-search"
        type="button"
        class="p-1 mr-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 opacity-0 pointer-events-none transition-opacity duration-200 rounded"
        aria-label="Clear search"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
      <button
        id="search-button"
        type="button"
        class="p-1 text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300 transition-colors duration-200 rounded"
        aria-label="Search"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </button>
    </div>
  </div>
  
  <!-- Search Type Description -->
  <div class="flex items-center justify-center mt-3">
    <div class="flex items-center px-3 py-1 bg-primary-50 dark:bg-primary-900/20 rounded-full border border-primary-200 dark:border-primary-800">
      <i id="search-type-icon" data-lucide="flag" class="w-4 h-4 mr-2 text-primary-600 dark:text-primary-400"></i>
      <span id="search-type-label" class="text-sm font-medium text-primary-700 dark:text-primary-300">Country Name</span>
    </div>
  </div>
  <p id="search-description" class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center">
    Search by country name (e.g., "Indonesia", "United States")
  </p>
  
  <!-- Search suggestions (will be populated via JS) -->
  <div 
    id="search-suggestions" 
    class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg hidden max-h-60 overflow-y-auto"
  >
    <!-- Suggestions will be dynamically added here -->
  </div>
</div>

<script>
  class SearchBar {
    private searchInput: HTMLInputElement | null;
    private clearButton: HTMLButtonElement | null;
    private suggestions: HTMLDivElement | null;
    private debounceTimer: number | null = null;
    private currentSearchType: string = 'name';
    private searchDescription: HTMLElement | null;
    private searchTypeIcon: HTMLElement | null;
    private searchTypeLabel: HTMLElement | null;

    constructor() {
      this.searchInput = document.getElementById('search-input') as HTMLInputElement;
      this.clearButton = document.getElementById('clear-search') as HTMLButtonElement;
      this.suggestions = document.getElementById('search-suggestions') as HTMLDivElement;
      this.searchDescription = document.getElementById('search-description');
      this.searchTypeIcon = document.getElementById('search-type-icon');
      this.searchTypeLabel = document.getElementById('search-type-label');
      
      this.init();
    }

    private init(): void {
      if (!this.searchInput || !this.clearButton) return;

      // Listen for search type changes from navbar
      document.addEventListener('search-type-changed', (e: Event) => {
        const customEvent = e as CustomEvent;
        this.handleSearchTypeChange(customEvent.detail.searchType);
      });

      // Handle input events
      this.searchInput.addEventListener('input', (e) => {
        const target = e.target as HTMLInputElement;
        this.handleInput(target.value);
      });

      // Handle clear button
      this.clearButton.addEventListener('click', () => {
        this.clearSearch();
      });

      // Handle focus events
      this.searchInput.addEventListener('focus', () => {
        if (this.searchInput?.value) {
          this.showSuggestions();
        }
      });

      // Handle click outside to close suggestions
      document.addEventListener('click', (e) => {
        if (!this.searchInput?.contains(e.target as Node) && 
            !this.suggestions?.contains(e.target as Node)) {
          this.hideSuggestions();
        }
      });

      // Dispatch search events immediately (real-time search)
      this.searchInput.addEventListener('input', (e) => {
        const target = e.target as HTMLInputElement;
        
        // Immediate search without debounce
        const event = new CustomEvent('country-search', {
          detail: { 
            query: target.value.trim(),
            searchType: this.currentSearchType
          }
        });
        document.dispatchEvent(event);
      });
    }

    private handleInput(value: string): void {
      // Show/hide clear button
      if (this.clearButton) {
        if (value) {
          this.clearButton.classList.remove('opacity-0', 'pointer-events-none');
          this.clearButton.classList.add('opacity-100');
        } else {
          this.clearButton.classList.add('opacity-0', 'pointer-events-none');
          this.clearButton.classList.remove('opacity-100');
        }
      }

      // Debounce search
      if (this.debounceTimer) {
        clearTimeout(this.debounceTimer);
      }

      this.debounceTimer = window.setTimeout(() => {
        if (value.trim()) {
          // In a real app, you'd fetch suggestions here
          this.showSuggestions();
        } else {
          this.hideSuggestions();
        }
      }, 300);
    }

    private clearSearch(): void {
      if (this.searchInput) {
        this.searchInput.value = '';
        this.searchInput.focus();
      }
      
      if (this.clearButton) {
        this.clearButton.classList.add('opacity-0', 'pointer-events-none');
      }
      
      this.hideSuggestions();
      
      // Dispatch clear event
      const event = new CustomEvent('country-search', {
        detail: { 
          query: '',
          searchType: this.currentSearchType
        }
      });
      document.dispatchEvent(event);
    }

    private showSuggestions(): void {
      if (this.suggestions) {
        this.suggestions.classList.remove('hidden');
      }
    }

    private hideSuggestions(): void {
      if (this.suggestions) {
        this.suggestions.classList.add('hidden');
      }
    }

    public updateSuggestions(countries: string[]): void {
      if (!this.suggestions) return;

      this.suggestions.innerHTML = '';

      countries.slice(0, 5).forEach(country => {
        const suggestion = document.createElement('div');
        suggestion.className = 'px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-gray-900 dark:text-white';
        suggestion.textContent = country;
        
        suggestion.addEventListener('click', () => {
          if (this.searchInput) {
            this.searchInput.value = country;
          }
          this.hideSuggestions();
          
          const event = new CustomEvent('country-search', {
            detail: { 
              query: country,
              searchType: this.currentSearchType
            }
          });
          document.dispatchEvent(event);
        });

        this.suggestions.appendChild(suggestion);
      });
    }

    private handleSearchTypeChange(searchType: string): void {
      // Update current search type
      this.currentSearchType = searchType;
      
      // Update placeholder and description
      this.updateSearchPlaceholder(searchType);
      
      // Clear current search and trigger new search if there's a value
      const currentValue = this.searchInput?.value || '';
      if (currentValue.trim()) {
        const event = new CustomEvent('country-search', {
          detail: { 
            query: currentValue.trim(),
            searchType: this.currentSearchType
          }
        });
        document.dispatchEvent(event);
      }
    }

    private updateSearchPlaceholder(searchType: string): void {
      if (!this.searchInput || !this.searchDescription || !this.searchTypeIcon || !this.searchTypeLabel) return;

      const searchConfigs = {
        name: {
          icon: 'flag',
          label: 'Country Name',
          placeholder: 'Search for a country...',
          description: 'Search by country name (e.g., "Indonesia", "United States")'
        },
        capital: {
          icon: 'landmark',
          label: 'Capital City',
          placeholder: 'Search by capital city...',
          description: 'Search by capital city (e.g., "Jakarta", "Washington")'
        },
        currency: {
          icon: 'coins',
          label: 'Currency',
          placeholder: 'Search by currency...',
          description: 'Search by currency (e.g., "USD", "Euro", "Rupiah")'
        },
        language: {
          icon: 'languages',
          label: 'Language',
          placeholder: 'Search by language...',
          description: 'Search by language (e.g., "English", "Spanish", "Indonesian")'
        },
        demonym: {
          icon: 'users',
          label: 'People',
          placeholder: 'Search by people...',
          description: 'Search by what people are called (e.g., "Indonesian", "American")'
        }
      };

      const config = searchConfigs[searchType as keyof typeof searchConfigs];
      if (config) {
        this.searchTypeIcon.setAttribute('data-lucide', config.icon);
        this.searchTypeLabel.textContent = config.label;
        this.searchInput.placeholder = config.placeholder;
        this.searchDescription.textContent = config.description;
        
        // Re-initialize Lucide icons for the updated icon
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
      }
    }
  }

  // Initialize search bar when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    new SearchBar();
    
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  });
</script>